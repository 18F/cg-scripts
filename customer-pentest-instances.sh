#!/usr/bin/env bash

function ec2instances() {
  aws ec2 describe-instances | jq "[.Reservations[] | .Instances[0] | select(.State.Name == \"running\") | {Name: .KeyName, PrivateIPAddress: .NetworkInterfaces[0].PrivateIpAddress, VPC: .VpcId, SubnetID: .SubnetId, InstanceID: .InstanceId, InstanceType: .InstanceType, Tags: [.Tags[] | {key: .Key, value: .Value}] | from_entries} | select(.Tags.Name | contains(\"$1\"))]"
}

echo "Routers"
ec2instances | jq 'map(select(.PrivateIPAddress | contains ("10.10"))) | map(select(.Tags.Name | contains("router"))) | .[].InstanceID'
echo "API"
ec2instances | jq 'map(select(.PrivateIPAddress | contains ("10.10"))) | map(select(.Tags.Name | contains("api"))) | .[].InstanceID'
echo "Diego Cells"
ec2instances | jq 'map(select(.PrivateIPAddress | contains ("10.10"))) | map(select(.Tags.Name | contains("cell"))) | .[].InstanceID'
